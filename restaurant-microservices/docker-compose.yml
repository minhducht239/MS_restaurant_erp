version: '3.8'

services:
  # ===========================================
  # DATABASE SERVICES
  # ===========================================
  mysql:
    image: mysql:8.0
    container_name: restaurant-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      MYSQL_DATABASE: restaurant_erp
      # Performance optimization
      MYSQL_INIT_CONNECT: 'SET collation_connection = utf8mb4_unicode_ci'
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql.cnf:/etc/mysql/conf.d/custom.cnf:ro
      # - ./init-db:/docker-entrypoint-initdb.d
    networks:
      - restaurant-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --innodb-buffer-pool-size=512M
      --innodb-log-file-size=128M
      --max-connections=200
      --query-cache-type=1
      --query-cache-size=64M
      --slow-query-log=1
      --long-query-time=2
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: restaurant-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - restaurant-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # API GATEWAY
  # ===========================================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: restaurant-gateway
    restart: always
    ports:
      - "8000:80"
    depends_on:
      - auth-service
      - menu-service
      - billing-service
      - customer-service
      - table-service
      - staff-service
      - reservation-service
    networks:
      - restaurant-network

  # ===========================================
  # MICROSERVICES
  # ===========================================
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: restaurant-auth-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-auth-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/0
      # Google OAuth Settings
      - GOOGLE_OAUTH2_CLIENT_ID=${GOOGLE_OAUTH2_CLIENT_ID:-}
      - GOOGLE_OAUTH2_CLIENT_SECRET=${GOOGLE_OAUTH2_CLIENT_SECRET:-}
      - GOOGLE_OAUTH2_REDIRECT_URI=${GOOGLE_OAUTH2_REDIRECT_URI:-http://localhost:3000/auth/google/callback}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "8001:8000"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - media_data:/app/media
    networks:
      - restaurant-network

  menu-service:
    build:
      context: ./services/menu-service
      dockerfile: Dockerfile
    container_name: restaurant-menu-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-menu-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/1
    ports:
      - "8002:8000"
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - media_data:/app/media
    networks:
      - restaurant-network

  billing-service:
    build:
      context: ./services/billing-service
      dockerfile: Dockerfile
    container_name: restaurant-billing-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-billing-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/2
      - AUTH_SERVICE_URL=http://auth-service:8000
      - CUSTOMER_SERVICE_URL=http://customer-service:8000
    ports:
      - "8003:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - restaurant-network

  customer-service:
    build:
      context: ./services/customer-service
      dockerfile: Dockerfile
    container_name: restaurant-customer-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-customer-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/3
    ports:
      - "8004:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - restaurant-network

  table-service:
    build:
      context: ./services/table-service
      dockerfile: Dockerfile
    container_name: restaurant-table-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-table-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/4
      - AUTH_SERVICE_URL=http://auth-service:8000
      - MENU_SERVICE_URL=http://menu-service:8000
      - BILLING_SERVICE_URL=http://billing-service:8000
    ports:
      - "8005:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - restaurant-network

  staff-service:
    build:
      context: ./services/staff-service
      dockerfile: Dockerfile
    container_name: restaurant-staff-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-staff-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/5
    ports:
      - "8006:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - restaurant-network

  reservation-service:
    build:
      context: ./services/reservation-service
      dockerfile: Dockerfile
    container_name: restaurant-reservation-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-reservation-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/6
    ports:
      - "8007:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - restaurant-network

  dashboard-service:
    build:
      context: ./services/dashboard-service
      dockerfile: Dockerfile
    container_name: restaurant-dashboard-service
    restart: always
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-django-insecure-dashboard-service-key}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=restaurant_erp
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-MinhDucA123@}
      - REDIS_URL=redis://redis:6379/7
    ports:
      - "8008:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - restaurant-network

networks:
  restaurant-network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  media_data:
