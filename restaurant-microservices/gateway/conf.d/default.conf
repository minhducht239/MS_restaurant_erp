# Upstream definitions for microservices
upstream auth_service {
    server auth-service:8000;
}

upstream menu_service {
    server menu-service:8000;
}

upstream billing_service {
    server billing-service:8000;
}

upstream customer_service {
    server customer-service:8000;
}

upstream table_service {
    server table-service:8000;
}

upstream staff_service {
    server staff-service:8000;
}

upstream reservation_service {
    server reservation-service:8000;
}

upstream dashboard_service {
    server dashboard-service:8000;
}

server {
    listen 80;
    server_name localhost;
    
    # Allow large file uploads (10MB)
    client_max_body_size 10M;

    location = / {
        default_type application/json;
        return 200 '{"status":"ok","service":"restaurant-api-gateway","version":"1.0.0"}';
    }

    location = /api/health {
        default_type application/json;
        return 200 '{"status":"healthy"}';
    }

    # Auth Service - with file upload support for avatar
    location /api/auth/ {
        proxy_pass http://auth_service/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Type $content_type;
        proxy_set_header Content-Length $content_length;
        
        # File upload settings for avatar
        client_max_body_size 5M;
        proxy_request_buffering off;
    }
    
    # Auth Service - serve avatar media files
    location /avatars/ {
        proxy_pass http://auth_service/media/avatars/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Menu Service - with file upload support
    location /api/menu/ {
        proxy_pass http://menu_service/api/menu/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Type $content_type;
        proxy_set_header Content-Length $content_length;
        
        # File upload settings
        client_max_body_size 10M;
        proxy_request_buffering off;
    }
    
    # Menu Service - serve media files
    location /media/ {
        proxy_pass http://menu_service/media/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Billing Service
    location /api/billing/ {
        proxy_pass http://billing_service/api/billing/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Customer Service
    location /api/customers/ {
        proxy_pass http://customer_service/api/customers/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Table Service
    location /api/tables/ {
        proxy_pass http://table_service/api/tables/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Staff Service
    location /api/staff/ {
        proxy_pass http://staff_service/api/staff/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Reservation Service
    location /api/reservations/ {
        proxy_pass http://reservation_service/api/reservations/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Dashboard Service
    location /api/dashboard/ {
        proxy_pass http://dashboard_service/api/dashboard/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
